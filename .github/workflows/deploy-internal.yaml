name: Deploy to Internal ECR

on:
  push:
    branches:
      - internal-build

env:
  AWS_REGION: us-east-2
  ECR_REGISTRY: 791996757309.dkr.ecr.us-east-2.amazonaws.com
  ECR_REPOSITORY: external-dns

jobs:
  deploy:
    name: Build and Push
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ vars.ARTIFACTS_DEV_CLOUD_AWS_IAM_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'  # Use a recent Go version

    - name: Setup ko
      uses: ko-build/setup-ko@v0.7
      with:
        version: v0.17.1

    - name: Build and Push with ko
      env:
        KO_DOCKER_REPO: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}
      run: |
        # Build for linux/amd64 explicitly. 
        # --bare ensures we don't push with the 'ko.local' tag prefix
        # --tags adds additional tags (sha)
        ko build --platform=linux/amd64 --bare --tags=latest,${{ github.sha }} .
